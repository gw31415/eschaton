# eschaton

選択ポリクリの病院割り当てをシミュレーションするためのツール。

## モチベーション

弊学の選択ポリクリは全6ターム6箇所周る必要があります。選び方の制限として、外病院3箇所、大学病院内診療科3箇所、外科3箇所、内科3箇所の制限を守る必要があり、各病院は各タームで受け入れ人数が決まっています。今年の決め方はドラフト制を採用し、タームと行き先の組み合わせを1つずつ投票していき、重複時に移動することを第1希望〜第6希望の6回行う方式となりました。

このツールは現時点での予約状況と残席数から、今後の競争がどうなるかを分析するためのツールとなります。

## 概要

このプログラムは、学生の希望と各病院の空き状況に基づいて、ランダムな割り当てシミュレーションを多数回実行します。シミュレーション結果から、全ての学生が割り当てられる確率や、割り当てに失敗しやすい学生のリストなどを統計情報として提供します。

## セットアップ

### 1. **Rust のインストール**

このプログラムを実行するには、Rust の開発環境が必要です。インストールされていない場合は、[rustup](https://rustup.rs/) を使ってインストールしてください。

### 2. **入力ファイルの準備**

プロジェクトの `./src/` ディレクトリ内に、以下の2つの CSV ファイルを配置する必要があります。
これらのファイルが存在しないと、プログラムはコンパイルエラーになります。

* `reserves.csv`: 各ターム（期間）における病院の空き状況を定義します。
* `students.csv`: 学生の情報と、事前に決まっている割り当てを定義します。

## 使い方

以下のコマンドでシミュレーションを実行します。

```bash
cargo run --release
```

シミュレーションは無期限に実行され、5秒ごとに `state.json` に現在の統計情報を保存します。コンソールにはより短い間隔で現在の状況が出力されます。

シミュレーションを停止するには、`Ctrl+C` を押してください。

## 出力の見方

プログラムを実行すると、以下のような形式で統計情報がコンソールに出力されます。

### 平均残席数

各ターム（①〜⑥）および各病院タイプ（院内内科、院内外科など）ごとの、シミュレーション終了時の平均残席数です。値は `残席数 / 試行回数` で計算された小数で表示されます。

```
+--------------+--------+--------+--------+--------+--------+--------+
| 平均残席数   | ①     | ②     | ③     | ④     | ⑤     | ⑥     |
+--------------+--------+--------+--------+--------+--------+--------+
| 院内内科     | 0.00   | 0.00   | 0.00   | 0.00   | 0.00   | 0.00   |
+--------------+--------+--------+--------+--------+--------+--------+
| 院内外科     | 0.00   | 0.00   | 0.00   | 0.00   | 0.00   | 0.00   |
+--------------+--------+--------+--------+--------+--------+--------+
| 院外内科     | 0.00   | 0.00   | 0.00   | 0.00   | 0.00   | 0.00   |
+--------------+--------+--------+--------+--------+--------+--------+
| 院外外科     | 0.00   | 0.00   | 0.00   | 0.00   | 0.00   | 0.00   |
+--------------+--------+--------+--------+--------+--------+--------+
```

### 試行回数と成功率

* `TRIAL`: 実行されたシミュレーションの総回数。
* `SUCCESS`: 全ての学生が病院に割り当てられた成功回数。
* `SUCCESS (%)`: 成功率。

### 割り当て失敗リスト

割り当てに失敗した学生のリストです。失敗回数が多い順にソートされています。

* 1列目: 順位
* 2列目: 学生名
* 3列目: 失敗回数
* 4列目: 失敗率 (`失敗回数 / TRIAL * 100`)

## 入力ファイルの詳細

### `reserves.csv`

各タームの各病院タイプの空き人数を定義します。
ヘッダー行が必要です。1行目から6行目が、それぞれターム①から⑥に対応します。

**フォーマット:**

```csv
inner_medical,inner_surgical,outer_medical,outer_surgical
10,10,10,10  // ターム①
10,10,10,10  // ターム②
...
```

### `students.csv`

学生のリストと、既に割り当てが決まっている病院を定義します。
ヘッダー行が必要です。`term1` から `term6` の列には、病院の種類を `院内内科`, `院内外科`, `院外内科`, `院外外科` のいずれかで指定します。空欄の場合は、そのタームの割り当てがまだ決まっていないことを意味します。

**フォーマット:**

```csv
name,term1,term2,term3,term4,term5,term6
学生A,院内内科,,,,,,
学生B,,院外外科,,,,,
...
```

## License

このプログラムは Apache-2.0 でライセンスされています。
